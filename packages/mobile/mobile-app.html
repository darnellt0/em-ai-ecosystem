<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Elevated Movements">
    <meta name="theme-color" content="#667eea">
    <title>Elevated Movements - AI Executive Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            overflow: hidden;
            touch-action: manipulation;
        }

        .app-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        .header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 16px;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-small {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .header-title {
            display: flex;
            flex-direction: column;
        }

        .header h1 {
            font-size: 16px;
            color: #f1f5f9;
            margin: 0;
            font-weight: 600;
        }

        .header-subtitle {
            font-size: 11px;
            color: #94a3b8;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .voice-button-large {
            width: 100%;
            padding: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
        }

        .voice-button-large:active {
            transform: scale(0.98);
        }

        .voice-button-large.recording {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: recording-pulse 1s infinite;
        }

        @keyframes recording-pulse {
            0%, 100% { box-shadow: 0 8px 16px rgba(239, 68, 68, 0.6); }
            50% { box-shadow: 0 8px 32px rgba(239, 68, 68, 0.8); }
        }

        .command-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .command-text {
            flex: 1;
        }

        .command-title {
            color: #f1f5f9;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .command-time {
            font-size: 12px;
            color: #64748b;
        }

        .command-status {
            padding: 4px 12px;
            background: #10b981;
            color: #0f172a;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .stat-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .stat-mini {
            flex: 1;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #94a3b8;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #cbd5e1;
            margin: 20px 0 12px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .nav-tab {
            padding: 8px 16px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #94a3b8;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .nav-tab:active,
        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .task-item {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-left: 4px solid #667eea;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-text {
            flex: 1;
        }

        .task-title {
            color: #f1f5f9;
            font-weight: 500;
        }

        .task-time {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #667eea;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .task-checkbox.checked {
            background: #667eea;
            color: white;
        }

        button {
            font-family: inherit;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .input-field {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 12px;
            color: #f1f5f9;
            width: 100%;
            margin-bottom: 12px;
            font-family: inherit;
            font-size: 14px;
        }

        .input-field::placeholder {
            color: #64748b;
        }

        .footer {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 12px;
            text-align: center;
            border-top: 1px solid #334155;
            font-size: 12px;
            color: #64748b;
        }

        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .message.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="header-left">
                <div class="logo-small">ü§ñ</div>
                <div class="header-title">
                    <h1>Elevated Movements</h1>
                    <span class="header-subtitle">AI Executive Assistant</span>
                </div>
            </div>
            <div class="status-dot"></div>
        </div>

        <div class="content">
            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchScreen('assistant')">Assistant</button>
                <button class="nav-tab" onclick="switchScreen('tasks')">Tasks</button>
                <button class="nav-tab" onclick="switchScreen('analytics')">Analytics</button>
                <button class="nav-tab" onclick="switchScreen('settings')">Settings</button>
            </div>

            <!-- AI Assistant Screen -->
            <div id="screen-assistant" class="screen active">
                <button class="voice-button-large" id="voiceBtn" onclick="toggleVoiceCommand()">
                    üé§ Tap to Speak
                </button>
                <button class="nav-tab" onclick="showMicrophoneHelp()" style="width: 100%; margin-top: 8px; font-size: 12px;">
                    ‚ùì Microphone Help
                </button>

                <input type="text" class="input-field" id="commandInput" placeholder="Or type your command here..." onkeypress="if(event.key==='Enter'){submitTextCommand()}">

                <div id="voiceOutput" class="hidden" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 1px solid #334155; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <div style="font-size: 12px; color: #94a3b8; margin-bottom: 8px;">You said:</div>
                    <div id="voiceText" style="color: #f1f5f9; font-weight: 500; font-size: 16px;"></div>
                </div>

                <div class="section-title">Recent Commands</div>
                <div id="recentCommands">
                    <div class="command-card">
                        <div class="command-text">
                            <div class="command-title">Block focus for 30 minutes</div>
                            <div class="command-time">Today at 2:30 PM</div>
                        </div>
                        <div class="command-status">‚úì Done</div>
                    </div>
                    <div class="command-card">
                        <div class="command-text">
                            <div class="command-title">Schedule team meeting</div>
                            <div class="command-time">Today at 1:15 PM</div>
                        </div>
                        <div class="command-status">‚úì Done</div>
                    </div>
                    <div class="command-card">
                        <div class="command-text">
                            <div class="command-title">Send email to Sarah</div>
                            <div class="command-time">Today at 12:45 PM</div>
                        </div>
                        <div class="command-status">‚úì Done</div>
                    </div>
                </div>
            </div>

            <!-- Tasks Screen -->
            <div id="screen-tasks" class="screen">
                <input type="text" class="input-field" placeholder="Add a new task...">

                <div class="section-title">Today</div>
                <div class="task-item">
                    <div class="task-text">
                        <div class="task-title">Review quarterly report</div>
                        <div class="task-time">Due: 5:00 PM</div>
                    </div>
                    <div class="task-checkbox"></div>
                </div>
                <div class="task-item">
                    <div class="task-text">
                        <div class="task-title">Team standup meeting</div>
                        <div class="task-time">3:00 PM</div>
                    </div>
                    <div class="task-checkbox"></div>
                </div>

                <div class="section-title">Tomorrow</div>
                <div class="task-item">
                    <div class="task-text">
                        <div class="task-title">Prepare presentation</div>
                        <div class="task-time">Due: 10:00 AM</div>
                    </div>
                    <div class="task-checkbox"></div>
                </div>
                <div class="task-item">
                    <div class="task-text">
                        <div class="task-title">Client call</div>
                        <div class="task-time">2:30 PM</div>
                    </div>
                    <div class="task-checkbox"></div>
                </div>
            </div>

            <!-- Analytics Screen -->
            <div id="screen-analytics" class="screen">
                <div class="section-title">Today's Stats</div>
                <div class="stat-row">
                    <div class="stat-mini">
                        <div class="stat-number">12</div>
                        <div class="stat-label">Commands</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-number">87%</div>
                        <div class="stat-label">Completed</div>
                    </div>
                </div>

                <div class="stat-row">
                    <div class="stat-mini">
                        <div class="stat-number">3.2h</div>
                        <div class="stat-label">Focus Time</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-number">5</div>
                        <div class="stat-label">Meetings</div>
                    </div>
                </div>

                <div class="section-title">This Week</div>
                <div class="command-card">
                    <div class="command-text">
                        <div class="command-title">Productivity Score</div>
                        <div class="command-time">Based on tasks completed</div>
                    </div>
                    <div style="font-size: 20px; font-weight: 700; color: #667eea;">8.4/10</div>
                </div>

                <div class="command-card">
                    <div class="command-text">
                        <div class="command-title">Focus Sessions</div>
                        <div class="command-time">Total uninterrupted time</div>
                    </div>
                    <div style="font-size: 20px; font-weight: 700; color: #667eea;">14.5h</div>
                </div>
            </div>

            <!-- Settings Screen -->
            <div id="screen-settings" class="screen">
                <div class="section-title">Voice Settings</div>
                <div class="task-item">
                    <div class="task-text">
                        <div class="task-title">Voice Recognition</div>
                        <div class="task-time">Enable microphone input</div>
                    </div>
                    <div style="color: #10b981;">‚úì</div>
                </div>

                <div class="section-title">Preferences</div>
                <div class="task-item">
                    <div class="task-text">
                        <div class="task-title">Dark Mode</div>
                        <div class="task-time">Current theme</div>
                    </div>
                    <div style="color: #667eea;">ON</div>
                </div>
                <div class="task-item">
                    <div class="task-text">
                        <div class="task-title">Notifications</div>
                        <div class="task-time">Task reminders</div>
                    </div>
                    <div style="color: #10b981;">‚úì</div>
                </div>

                <div class="section-title">System</div>
                <div class="command-card">
                    <div class="command-text">
                        <div class="command-title">API Connection</div>
                        <div class="command-time">Backend status</div>
                    </div>
                    <div class="command-status">‚úì Connected</div>
                </div>
                <div class="command-card">
                    <div class="command-text">
                        <div class="command-title">App Version</div>
                        <div class="command-time">Latest release</div>
                    </div>
                    <div style="color: #667eea; font-weight: 600;">v1.0.0</div>
                </div>
            </div>
        </div>

        <div class="footer">
            Elevated Movements ¬© 2024 ‚Ä¢ AI Executive Assistant
        </div>
    </div>

    <div id="message" class="message"></div>

    <script>
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];

        function switchScreen(screenName) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });

            // Deactivate all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected screen
            document.getElementById('screen-' + screenName).classList.add('active');

            // Activate selected tab
            event.target.classList.add('active');
        }

        async function toggleVoiceCommand() {
            const voiceBtn = document.getElementById('voiceBtn');

            if (isRecording) {
                stopVoiceCommand();
            } else {
                startVoiceCommand();
            }
        }

        async function startVoiceCommand() {
            const voiceBtn = document.getElementById('voiceBtn');

            // Try to clear any blocked permissions by using try-catch
            try {
                // First attempt: check if we can get audio stream (this triggers permission prompt)
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: { echoCancellation: true, noiseSuppression: true }
                });

                // If we got here, we have permission - stop the stream and use Web Speech API
                stream.getTracks().forEach(track => track.stop());
                startSpeechRecognition();
            } catch (err) {
                // Permission was denied OR the browser blocked it
                // Fall back to Web Speech API which might still work
                console.log('getUserMedia failed:', err.name);

                if (err.name === 'NotAllowedError') {
                    // Try Web Speech API anyway - it may request permission fresh
                    showMessage('üîê Requesting microphone access...');
                    setTimeout(() => {
                        startSpeechRecognition();
                    }, 500);
                } else {
                    // Try Web Speech API
                    startSpeechRecognition();
                }
            }
        }

        function startSpeechRecognition() {
            const voiceBtn = document.getElementById('voiceBtn');
            const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;

            if (!SpeechRecognition) {
                showMessage('‚ùå Voice recognition not supported in this browser');
                return;
            }

            isRecording = true;
            voiceBtn.classList.add('recording');
            voiceBtn.textContent = 'üé§ Listening... Speak now';
            showMessage('üé§ Listening... Speak your command');

            useWebSpeechAPI();
        }

        function useWebSpeechAPI() {
            const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
            const voiceBtn = document.getElementById('voiceBtn');

            if (!SpeechRecognition) {
                showMessage('‚ùå Voice recognition not supported in this browser');
                isRecording = false;
                voiceBtn.classList.remove('recording');
                voiceBtn.textContent = 'üé§ Tap to Speak';
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.language = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;

            let finalTranscript = '';

            recognition.onstart = () => {
                finalTranscript = '';
                console.log('Speech recognition started');
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;

                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // Show interim results while speaking
                const allText = (finalTranscript || interimTranscript).trim();
                if (allText) {
                    document.getElementById('voiceOutput').classList.remove('hidden');
                    document.getElementById('voiceText').textContent = allText;
                }

                // When speech ends
                if (event.results[event.results.length - 1].isFinal) {
                    finalTranscript = finalTranscript.trim();
                    if (finalTranscript) {
                        showMessage('‚úÖ Command: ' + finalTranscript);
                        sendCommandToBackend(finalTranscript);
                    } else {
                        showMessage('‚ö†Ô∏è No speech detected');
                    }

                    isRecording = false;
                    voiceBtn.classList.remove('recording');
                    voiceBtn.textContent = 'üé§ Tap to Speak';
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isRecording = false;
                voiceBtn.classList.remove('recording');
                voiceBtn.textContent = 'üé§ Tap to Speak';

                if (event.error === 'network') {
                    showMessage('‚ö†Ô∏è Network error. Try again.');
                } else if (event.error === 'no-speech') {
                    showMessage('‚ö†Ô∏è No speech detected. Try again.');
                } else if (event.error === 'not-allowed') {
                    showMessage('üîê Check if microphone permission popup appeared. If not, you may need to reset permissions in Chrome Settings.');
                } else if (event.error === 'audio-capture') {
                    showMessage('‚ùå Microphone error. Try using text input below instead.');
                } else {
                    showMessage('‚ö†Ô∏è Error: ' + event.error + '. Try text input instead.');
                }
            };

            recognition.onend = () => {
                console.log('Speech recognition ended');
                isRecording = false;
                voiceBtn.classList.remove('recording');
                voiceBtn.textContent = 'üé§ Tap to Speak';
            };

            try {
                recognition.start();
                console.log('Recognition started successfully');
            } catch (err) {
                console.error('Recognition start error:', err);
                showMessage('‚ùå Error starting voice recognition');
                isRecording = false;
                voiceBtn.classList.remove('recording');
                voiceBtn.textContent = 'üé§ Tap to Speak';
            }
        }

        function stopVoiceCommand() {
            const voiceBtn = document.getElementById('voiceBtn');
            // Web Speech API stops automatically after a few seconds of silence
            // or when it detects end of speech
            isRecording = false;
            voiceBtn.classList.remove('recording');
            voiceBtn.textContent = 'üé§ Tap to Speak';
        }

        async function sendCommandToBackend(transcript) {
            try {
                showMessage('‚è≥ Processing your command...');

                // Use the hybrid endpoint - smart routing that tries deterministic agents first,
                // then falls back to OpenAI for complex reasoning
                const response = await fetch(`http://localhost:3000/api/voice/hybrid`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer elevenlabs-voice-secure-token-2025'
                    },
                    body: JSON.stringify({
                        transcript: transcript,
                        founder: 'darnell'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Hybrid Response:', result);

                    // Display routing information
                    let routeInfo = '';
                    if (result.route === 'deterministic') {
                        routeInfo = result.complexity === 'simple' ? '‚ö° Fast' : 'üîç Smart';
                    } else if (result.route === 'openai') {
                        routeInfo = 'ü§î Reasoning';
                    }

                    // Show latency and cost
                    let costInfo = '';
                    if (result.latency) {
                        costInfo = ` [${result.latency}ms]`;
                    }
                    if (result.cost && result.cost > 0) {
                        costInfo += ` ($${result.cost.toFixed(4)})`;
                    }

                    // Display the agent's response to the user
                    if (result.humanSummary) {
                        showMessage(routeInfo + ' ' + result.humanSummary + costInfo);

                        // Also add to recent commands with route information
                        addRecentCommand(transcript, result.humanSummary, result.route, result.latency, result.cost);
                    } else {
                        showMessage('‚úÖ Command processed successfully' + costInfo);
                    }

                    console.log(`Route: ${result.route} | Complexity: ${result.complexity} | Latency: ${result.latency}ms | Cost: $${(result.cost || 0).toFixed(4)}`);
                } else {
                    const error = await response.json();
                    showMessage('‚ö†Ô∏è ' + (error.humanSummary || error.message || 'Command failed'));
                }
            } catch (err) {
                console.error('Backend error:', err);
                showMessage('‚ùå Connection error. Check if backend is running on port 3000.');
            }
        }

        function detectIntent(transcript) {
            const lower = transcript.toLowerCase();

            // Scheduler intents
            if (lower.includes('block') || lower.includes('focus')) return 'block-focus';
            if (lower.includes('schedule') || lower.includes('meeting')) return 'schedule-meeting';
            if (lower.includes('reschedule') || lower.includes('change')) return 'reschedule';

            // Wellness intents
            if (lower.includes('pause') || lower.includes('meditate') || lower.includes('breathe')) return 'pause';

            // Task intents
            if (lower.includes('complete') || lower.includes('done') || lower.includes('finished')) return 'complete-task';
            if (lower.includes('follow') || lower.includes('remind')) return 'follow-up';

            // Analytics intents
            if (lower.includes('brief') || lower.includes('summary')) return 'daily-brief';
            if (lower.includes('insights') || lower.includes('analytics')) return 'insights';

            // Business intents
            if (lower.includes('grant')) return 'grants';
            if (lower.includes('relationship') || lower.includes('contact')) return 'relationships';
            if (lower.includes('budget')) return 'budget';
            if (lower.includes('content')) return 'content';
            if (lower.includes('brand') || lower.includes('story')) return 'brand-story';

            return null;
        }

        function mapIntentToEndpoint(intent) {
            const endpoints = {
                'block-focus': '/api/voice/scheduler/block',
                'schedule-meeting': '/api/voice/scheduler/confirm',
                'reschedule': '/api/voice/scheduler/reschedule',
                'pause': '/api/voice/coach/pause',
                'complete-task': '/api/voice/support/log-complete',
                'follow-up': '/api/voice/support/follow-up',
                'daily-brief': '/api/voice/analytics/daily-brief',
                'insights': '/api/voice/analytics/insights',
                'grants': '/api/voice/business/grants',
                'relationships': '/api/voice/business/relationships',
                'budget': '/api/voice/business/budget',
                'content': '/api/voice/business/content',
                'brand-story': '/api/voice/business/brand-story'
            };
            return endpoints[intent];
        }

        function buildPayload(intent, transcript) {
            // Default founder (you can change this or make it dynamic)
            const founder = 'darnell';

            const payloads = {
                'block-focus': {
                    minutes: extractNumber(transcript, 15),
                    reason: transcript,
                    founder: founder
                },
                'schedule-meeting': {
                    title: extractTitle(transcript) || 'Meeting',
                    startAtISO: new Date().toISOString(),
                    durationMinutes: extractNumber(transcript, 30),
                    founder: founder
                },
                'reschedule': {
                    eventId: 'event-1',
                    newStartAtISO: new Date().toISOString(),
                    newDurationMinutes: extractNumber(transcript, 30),
                    founder: founder
                },
                'pause': {
                    style: 'grounding',
                    seconds: extractNumber(transcript, 60),
                    founder: founder
                },
                'complete-task': {
                    taskId: 'task-1',
                    note: transcript,
                    founder: founder
                },
                'follow-up': {
                    subject: extractTitle(transcript) || 'Follow-up',
                    context: transcript,
                    founder: founder
                },
                'daily-brief': {
                    founder: founder
                },
                'insights': {
                    founder: founder,
                    timeframe: 'daily'
                },
                'grants': {
                    founder: founder
                },
                'relationships': {
                    founder: founder,
                    contactId: extractTitle(transcript) || 'contact-1',
                    action: 'interaction'
                },
                'budget': {
                    founder: founder,
                    totalBudget: extractNumber(transcript, 10000),
                    goals: ['growth', 'efficiency']
                },
                'content': {
                    founder: founder,
                    platform: 'social',
                    topic: transcript
                },
                'brand-story': {
                    founder: founder,
                    companyName: 'Elevated Movements',
                    values: ['innovation', 'excellence']
                }
            };

            return payloads[intent] || { founder: founder };
        }

        function extractNumber(text, defaultNum = 0) {
            const match = text.match(/\d+/);
            return match ? parseInt(match[0]) : defaultNum;
        }

        function extractTitle(text) {
            // Simple extraction - take first few words
            return text.split(' ').slice(0, 3).join(' ');
        }

        function addRecentCommand(command, response, route, latency, cost) {
            const recentList = document.getElementById('recentList');
            if (!recentList) return;

            // Determine route styling
            let routeEmoji = '‚ö°';
            let routeColor = '#10b981';
            if (route === 'deterministic' && latency > 150) {
                routeEmoji = 'üîç';
                routeColor = '#3b82f6';
            } else if (route === 'openai') {
                routeEmoji = 'ü§î';
                routeColor = '#f59e0b';
            }

            // Build metadata string
            let metadata = '';
            if (latency) {
                metadata += `${latency}ms`;
            }
            if (cost && cost > 0) {
                if (metadata) metadata += ' ‚Ä¢ ';
                metadata += `$${cost.toFixed(4)}`;
            }
            if (!metadata) {
                metadata = 'Just now';
            }

            const item = document.createElement('div');
            item.style.cssText = 'padding: 12px 16px; background: rgba(99, 102, 241, 0.1); border-left: 3px solid #6366f1; margin-bottom: 8px; border-radius: 4px;';
            item.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 18px;">${routeEmoji}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 500; color: #f1f5f9;">${command}</div>
                        <div style="font-size: 12px; color: #cbd5e1; margin-top: 4px;">${response}</div>
                        <div style="font-size: 11px; color: #64748b; margin-top: 4px;">${metadata}</div>
                    </div>
                </div>
            `;
            recentList.insertBefore(item, recentList.firstChild);

            // Keep only last 10 commands
            while (recentList.children.length > 10) {
                recentList.removeChild(recentList.lastChild);
            }
        }

        function showMessage(text) {
            const msgEl = document.getElementById('message');
            msgEl.textContent = text;
            msgEl.classList.add('show');
            setTimeout(() => {
                msgEl.classList.remove('show');
            }, 3000);
        }

        function submitTextCommand() {
            const input = document.getElementById('commandInput');
            const text = input.value.trim();

            if (!text) {
                showMessage('‚ö†Ô∏è Please type a command');
                return;
            }

            document.getElementById('voiceOutput').classList.remove('hidden');
            document.getElementById('voiceText').textContent = text;
            showMessage('‚úÖ Command: ' + text);

            sendCommandToBackend(text);
            input.value = '';
        }

        function showMicrophoneHelp() {
            const helpText = `
MICROPHONE SETUP INSTRUCTIONS

üì± On Android (Chrome):
1. Tap the three dots (‚ãÆ) menu
2. Go to Settings
3. Scroll down to Permissions
4. Find Microphone
5. Make sure 10.0.0.249:19006 is set to "Allow"
6. Go back and try the voice button

üíª On Desktop (Chrome):
1. Click the padlock icon in the address bar
2. Find Microphone permissions
3. Change from "Block" to "Allow"
4. Reload the page
5. Try the voice button again

If still not working:
- Use the text input field instead
- Type your command and press Enter
- It works just as well!

Need help? Check browser console (F12) for errors.
            `.trim();

            alert(helpText);
        }

        // Task checkbox toggle
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('task-checkbox')) {
                e.target.classList.toggle('checked');
                e.target.textContent = e.target.classList.contains('checked') ? '‚úì' : '';
            }
        });

        // Check backend on load
        fetch('http://localhost:3000/health', { mode: 'no-cors' })
            .then(() => console.log('‚úì Backend connected'))
            .catch(() => console.log('Note: Backend not available (offline mode)'));
    </script>
</body>
</html>
